<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Book Near Me ‚Äî Seller & Buyer</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.26.0/dist/supabase.min.js"></script>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f1724; --panel:rgba(255,255,255,0.06); --text:#e6eef8; --muted:#90a0b6;
  --accent-start:#7c3aed; --accent-end:#06b6d4;
}
[data-theme="light"]{
  --bg:#f4f7fb; --panel:rgba(255,255,255,0.92); --text:#0b1220; --muted:#334155;
}
html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Arial; background:var(--bg); color:var(--text); display:flex; flex-direction:column;}
header{display:flex; justify-content:space-between; align-items:center; padding:14px 18px; backdrop-filter: blur(6px);}
.brand{display:flex; align-items:center; gap:12px;}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 18px rgba(8,8,15,0.4);}
.title{font-weight:600;font-size:18px;}
.controls{display:flex; gap:10px; align-items:center;}
.btn{border:none;padding:10px 12px;border-radius:10px;cursor:pointer;background:var(--panel);color:var(--text);font-weight:600;}
.btn.primary{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:white;box-shadow:0 6px 18px rgba(0,0,0,0.35);}
main{display:grid; grid-template-columns:1fr; gap:18px; padding:18px; flex:1; min-height:0;}
#map{width:100%; height:calc(100vh - 80px); border-radius:12px; box-shadow:0 8px 26px rgba(2,6,23,0.6);}
.modal {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,36,0.95); display:none; justify-content:center; align-items:center; z-index:999; overflow:auto;}
.modal.active{display:flex;}
.modal-content{background:var(--panel); backdrop-filter:blur(16px); padding:28px; border-radius:20px; width:90%; max-width:500px; animation:fadeIn 0.4s ease;}
input, select{width:100%; padding:12px; border-radius:12px; border:none; margin-top:10px; background:rgba(255,255,255,0.05); color:var(--text);}
textarea{width:100%; padding:12px; border-radius:12px; border:none; margin-top:10px; background:rgba(255,255,255,0.05); color:var(--text);}
.progress-bar {height:6px; background:#06b6d4; width:0%; border-radius:3px; margin-top:10px; transition: width 0.3s;}
#postsList{margin-top:12px;}
@keyframes fadeIn {from{opacity:0; transform:scale(0.96);} to{opacity:1; transform:scale(1);}}
</style>
</head>
<body data-theme="dark">

<header>
  <div class="brand">
    <div class="logo">B</div>
    <div>
      <div class="title">Book Near Me</div>
      <div class="muted" style="font-size:12px">Realtime book map</div>
    </div>
  </div>
  <div class="controls">
    <label class="switch muted">
      <input id="modeToggle" type="checkbox" style="width:0;height:0;opacity:0;"/>
      <span id="modeLabel" class="muted">Dark</span>
    </label>
    <button class="btn" id="myLocationBtn">üìç My Location</button>
    <button class="btn primary" id="subscribeBtn">üì∫ Subscribe NS Jagat</button>
    <button class="btn primary" id="postBookBtn">üìö Post Your Book</button>
  </div>
</header>

<main>
  <div id="map"></div>
</main>

<!-- Post Book Modal -->
<div class="modal" id="bookModal">
  <div class="modal-content">
    <h3 style="margin:0 0 10px 0;">Post Your Book</h3>
    <select id="bookType">
      <option value="individual">Individual Book</option>
      <option value="academic">Academic Book Set</option>
    </select>
    <input id="titleIn" placeholder="Book Title">
    <input id="authorIn" placeholder="Author / Set Name">
    <input id="whatsappIn" placeholder="WhatsApp Number">
    <input id="emailIn" placeholder="Email (optional)">
    <select id="categoryIn">
      <option>Fiction</option><option>Non-Fiction</option><option>Education</option><option>Technology</option><option>Kids</option>
    </select>
    <input id="imageIn" type="file" accept="image/*">
    <button class="btn primary" id="submitBookBtn">Submit</button>
    <div class="progress-bar" id="progressBar"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.30.0/dist/supabase.min.js"></script>

<script>
// --- Supabase init ---
const SUPABASE_URL = "https://pjydlzeuxmtaowpgqmol.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqeWRsemV1eG10YW93cGdxbW9sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzkzMTAsImV4cCI6MjA4MDQxNTMxMH0.DjskIRS3PzSq01U-XxSClRK5Uy0n_bWrAFUHSacSNfo";
const supabase = Supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

// --- Theme Toggle ---
const modeToggle = document.getElementById('modeToggle');
const modeLabel = document.getElementById('modeLabel');
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  modeLabel.innerText = theme==='dark'?'Dark':'Light';
  localStorage.setItem('bm_theme',theme);
}
modeToggle.addEventListener('change',()=>applyTheme(modeToggle.checked?'light':'dark'));
applyTheme(localStorage.getItem('bm_theme')||'dark');

// --- Map ---
let map = L.map('map').setView([26,84],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
let markersLayer = L.layerGroup().addTo(map);

// --- My Location ---
document.getElementById('myLocationBtn').addEventListener('click',()=>{
  if(!navigator.geolocation){alert('Geolocation not supported'); return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    map.setView([lat,lng],12);
    L.circle([lat,lng],{radius:200,color:'#06b6d4',opacity:0.6}).addTo(map);
  },err=>alert('Location access denied or error'));
});

// --- Subscribe Button ---
document.getElementById('subscribeBtn').addEventListener('click',()=>{
  window.open("https://www.youtube.com/@nsjagat-c?sub_confirmation=1","_blank");
});

// --- Post Book Modal ---
const postBookBtn = document.getElementById('postBookBtn');
const bookModal = document.getElementById('bookModal');
postBookBtn.addEventListener('click',()=>bookModal.classList.add('active'));
bookModal.addEventListener('click',e=>{if(e.target===bookModal) bookModal.classList.remove('active');});

</script>
<script>
// --- Post Book Submit ---
const submitBtn = document.getElementById('submitBookBtn');
const progressBar = document.getElementById('progressBar');

async function compressImage(file, maxSizeMB = 1) {
  if (!file) return null;
  return new Promise((resolve)=>{
    const reader = new FileReader();
    reader.onload = e=>{
      const img = new Image();
      img.src = e.target.result;
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        const scale = Math.sqrt(maxSizeMB * 1024 * 1024 / (file.size));
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        canvas.toBlob(blob=>{
          resolve(new File([blob], file.name, {type:file.type}));
        }, file.type, 0.8);
      }
    };
    reader.readAsDataURL(file);
  });
}

submitBtn.addEventListener('click', async ()=>{
  const title=document.getElementById('titleIn').value.trim();
  const author=document.getElementById('authorIn').value.trim();
  const whatsapp=document.getElementById('whatsappIn').value.trim();
  const email=document.getElementById('emailIn').value.trim();
  const category=document.getElementById('categoryIn').value;
  const type=document.getElementById('bookType').value;
  const imageFile=document.getElementById('imageIn').files[0];

  if(!title||!author||!whatsapp){alert("Please fill title, author and WhatsApp."); return;}

  progressBar.style.width="10%";

  // Compress image
  let compressedFile = await compressImage(imageFile);
  progressBar.style.width="30%";

  // Upload image to Supabase Storage
  let imageUrl = '';
  if(compressedFile){
    const {data, error} = await supabase.storage.from('book-images').upload(`books/${Date.now()}_${compressedFile.name}`, compressedFile);
    if(error){alert("Image upload failed: "+error.message); return;}
    const {publicUrl} = supabase.storage.from('book-images').getPublicUrl(data.path);
    imageUrl = publicUrl;
  }

  progressBar.style.width="60%";

  // Get geolocation
  let lat=0,lng=0;
  try{
    await new Promise((resolve,reject)=>{
      navigator.geolocation.getCurrentPosition(pos=>{
        lat=pos.coords.latitude;
        lng=pos.coords.longitude;
        resolve();
      },err=>{lat=0;lng=0;resolve();});
    });
  }catch(e){lat=0;lng=0;}

  progressBar.style.width="80%";

  // Insert into Supabase
  const {data, error} = await supabase.from('books').insert([{
    title, author, whatsapp, email, category, type, image_url:imageUrl, lat, lng, status:'pending', created_at:new Date().toISOString()
  }]);
  if(error){alert("Error: "+error.message); return;}

  progressBar.style.width="100%";

  // Redirect to WhatsApp for manual approval
  window.open(`https://wa.me/${whatsapp}?text=Hello,%20your%20book%20"${title}"%20has%20been%20submitted%20for%20review.%20We%20will%20approve%20soon.%20Your%20data%20is%20safe.`,'_blank');

  progressBar.style.width="0%";
  bookModal.classList.remove('active');
  alert("Book submitted! Please send WhatsApp confirmation.");
  loadBooks(); // Refresh map
});

// --- Load Books on Map ---
async function loadBooks(){
  const {data,error} = await supabase.from('books').select('*');
  if(error){console.log(error); return;}
  markersLayer.clearLayers();
  data.forEach(b=>{
    if(b.lat && b.lng){
      const marker = L.marker([b.lat,b.lng]).addTo(markersLayer);
      marker.bindPopup(`
        <b>${b.title}</b><br>
        ${b.author}<br>
        ${b.category}<br>
        Status: ${b.status}<br>
        <a href="https://wa.me/${b.whatsapp}" target="_blank">Contact via WhatsApp</a>
      `);
    }
  });
}
loadBooks();

// --- Auto refresh map every 15 sec for realtime ---
setInterval(loadBooks,15000);
      </script>
